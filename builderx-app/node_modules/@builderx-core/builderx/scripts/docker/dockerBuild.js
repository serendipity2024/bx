const jsdom = require("jsdom");
const { JSDOM } = jsdom;

var fs = require("fs");

JSDOM.fromFile("./build/index.html").then(dom => {
  addMetaData(dom);
  writeFile(dom, "./build/index.ejs");
});

JSDOM.fromFile("./build/mobile-index.html").then(dom => {
  addMetaData(dom);
  addImageInBody(dom);
  writeFile(dom, "./build/mobile-index.ejs");
});

function addImageInBody(dom) {
  const body = dom.window.document.querySelector("body");
  var node = dom.window.document.createElement("img");
  node.src = `<%- bxEnv.BUILDERX_PROJECT_IMAGE %>`;
  body.appendChild(node);
}

function addMetaData(dom) {
  const header = dom.window.document.querySelector("head");
  var title = header.getElementsByTagName("title")[0];
  if (title) {
    header.removeChild(title);
  }

  var titleNode = dom.window.document.createElement("title");
  header.appendChild(titleNode);

  titleNode.innerHTML = `<%- title %>`;

  var metaOGTitle = dom.window.document.createElement("meta");
  metaOGTitle.setAttribute("property", "og:title");
  metaOGTitle.content = `<%- bxEnv.BUILDERX_PROJECT_TITLE %>`;
  header.appendChild(metaOGTitle);

  var metaOGDescription = dom.window.document.createElement("meta");
  metaOGDescription.setAttribute("property", "og:description");
  metaOGDescription.content = `<%- bxEnv.BUILDERX_PROJECT_DESCRIPTION %>`;
  header.appendChild(metaOGDescription);

  var metaDescription = dom.window.document.createElement("meta");
  metaDescription.setAttribute("name", "description");
  metaDescription.content = `<%- bxEnv.BUILDERX_PROJECT_DESCRIPTION %>`;
  header.appendChild(metaDescription);

  var metaOGSiteName = dom.window.document.createElement("meta");
  metaOGSiteName.setAttribute("property", "og:site_name");
  metaOGSiteName.content = `BuilderX.io`;
  header.appendChild(metaOGSiteName);

  var metaKeyword = dom.window.document.createElement("meta");
  metaKeyword.setAttribute("name", "keywords");
  metaKeyword.content = `BuilderX`;
  header.appendChild(metaKeyword);

  var metaImage = dom.window.document.createElement("meta");
  metaImage.setAttribute("property", "og:image");
  metaImage.content = `<%- bxEnv.BUILDERX_PROJECT_IMAGE %>`;
  header.appendChild(metaImage);

  var metaOGUrl = dom.window.document.createElement("meta");
  metaOGUrl.setAttribute("property", "og:url");
  metaOGUrl.content = `<%- bxEnv.BUILDERX_PROJECT_URL %>`;
  header.appendChild(metaOGUrl);

  var node = dom.window.document.createElement("script");
  header.appendChild(node);
  node.innerHTML = "bxEnv = <%- JSON.stringify(bxEnv) %>; ";
}

function writeFile(dom, destinationPath) {
  fs.writeFile(
    destinationPath,
    "<!DOCTYPE html>" +
      dom.window.document.documentElement.outerHTML
        .replace(/&lt;/g, "<")
        .replace(/&gt;/g, ">"),
    function(err) {
      if (err) {
        return console.log(err);
      }
      console.log("The file", destinationPath, "was saved!");
    }
  );
}
