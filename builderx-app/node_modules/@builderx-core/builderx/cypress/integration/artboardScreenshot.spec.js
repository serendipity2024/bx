// import loginTests from "./login.spec";
import { scrollToArtboard } from "./actions/scroll";
import { find } from "lodash";

const SketchFileName = "iphoneSE.sketch";
let count;
// function screenshotScript() {
context("Takes Screenshots of artboard after importing sketch file", () => {
  before(function() {
    cy.request("POST", "http://builderx-api.geekydev.com/authentication", {
      strategy: "local",
      email: "mukulp@geekyants.com",
      password: "goldtree9"
    }).then(response => {
      expect(response.body).to.have.property("accessToken");
      cy.setCookie("access-token", response.body.accessToken);
      if (
        Cypress.env("projURL") === undefined ||
        Cypress.env("projURL") === "undefined"
      ) {
        cy.visit("http://localhost:3000/");
      } else {
        cy.visit(Cypress.env("projURL"));
      }
    });
  });

  beforeEach(function() {
    Cypress.Cookies.preserveOnce("access-token");
  });

  it("can open the core app", function() {
    cy.url().should("include", "http://localhost:3000/");
    cy.get("div[data-cypress-id=artboard] > .view-render", { timeout: 10000 });
  });

  it("can import sketch file", function() {
    if (
      !(
        Cypress.env("projURL") === undefined ||
        Cypress.env("projURL") === "undefined"
      )
    ) {
      this.skip();
    }

    cy.document().trigger("dragenter");
    cy.dropFile(SketchFileName);
    cy.get(".modalContentX .windowFooterX button", { timeout: 20000 })
      .contains(/^import$/i)
      .click();
    cy.get("div.spinnerX", { timeout: 100000 }).should("not.exist");
    cy.url().then(url => {
      cy.task("log", `@@@ project URL: ${url} @@@`);
    });
  });

  it("will capture screenshot and sync the artboard in react native", function() {
    cy.get("div[data-cypress-id=artboard]").each(function(artboard) {
      cy.wrap(artboard).scrollIntoView({
        duration: 100,
        easing: "linear",
        offset: { top: -50, left: -60 }
      });
      let folderName;
      cy.task("log", "artboard");
      // xcy.task("log", artboard);
      folderName = artboard
        .attr("class")
        .split(" ")[0]
        .replace("bx-artboard-", "");
      // cy.task("log", folderName);
      // cy.wrap(artboard)
      //   .its("class")
      //   .then(classes => {
      //     classArray = classes.split(" ");
      //     folderName = find(classArray, element => {
      //       return element.startsWith("bx-artboard-");
      //     });
      //   });
      cy.task("log", "folderName: ***" + folderName);
      cy.wait(1000);
      cy.wrap(artboard).screenshot(`${folderName}/builderX`);

      cy.wrap(artboard).then(elem => {
        var elemPos = Cypress.dom.getElementCoordinatesByPosition(elem);
        return cy
          .get("body")
          .click(elemPos.fromViewport.left + 5, elemPos.fromViewport.top - 5);
      });

      cy.get("body").type("{command}{option}{shift}s");
      cy.task("log", "React Native Sync Done");
      cy.wait(5000);
    });

    // .its("length")
    // .then(len => {
    //   count = len;
    //   cy.task("log", "artboards count = " + len);
    //   if (len >= 1) {
    //     cy.task("log", "lastArtboard");
    //   }
    //   if (len >= 1) {
    //     screenshotSyncAndDelete();
    //   }
    // });
  });

  it("will select react code language", function() {
    cy.get("div[data-cypress-id=get-code-tab]").click();
    cy.get("button[data-cypress-id=react-code-button]").click();
    cy.get("div[data-cypress-id=get-design-tab]").click();
  });

  it("will sync the artboard in react ", function() {
    cy.get("div[data-cypress-id=artboard]").each(function(artboard) {
      cy.wrap(artboard).scrollIntoView({
        duration: 100,
        easing: "linear",
        offset: { top: -50, left: -60 }
      });

      let folderName = artboard
        .attr("class")
        .split(" ")[0]
        .replace("bx-artboard-", "");

      cy.task("log", "folderName: ***" + folderName);

      cy.wrap(artboard).then(elem => {
        var elemPos = Cypress.dom.getElementCoordinatesByPosition(elem);
        return cy
          .get("body")
          .click(elemPos.fromViewport.left + 5, elemPos.fromViewport.top - 5);
      });

      cy.get("body").type("{command}{option}{shift}s");
      cy.task("log", "React Sync Done");
      cy.wait(5000);
    });
  });
});

// function screenshotSyncAndDelete() {
//   context("Screenshot of artboard and syncing", function() {
//     it("can take screenshot of the artboard", () => {
//       cy.task("log", "function screen");
//       cy.get("div[data-cypress-id=file-header]")
//         .first()
//         .invoke("text")
//         .then(text => {
//           var folderName = text.replace(".js", "");
//           cy.task("log", `folderName ${folderName}`);

//           // scrollToArtboard("div[class^=bx-artboard-]");
//           // cy.get("div[data-cypress-id=artboard]")
//           //   .first()
//           //   .screenshot(`${folderName}/builderX`);
//         });
//     });

//     it("will sync file to react native app", function() {
//       cy.get("div[data-cypress-id=artboard]")
//         .first()
//         .then(elem => {
//           var elemPos = Cypress.dom.getElementCoordinatesByPosition(elem);
//           return cy
//             .get("body")
//             .click(elemPos.fromViewport.left + 5, elemPos.fromViewport.top - 5);
//         });

//       cy.get("body").type("{command}{option}{shift}s");
//       cy.wait(5000);
//       cy.task("log", "Sync Done");
//     });

//     it("will delete the artboard", () => {
//       // scrollToArtboard("div[data-cypress-id=artboard] > .view-render");
//       if (count !== 1) {
//         cy.get("div[data-cypress-id=artboard] > .view-render", {
//           timeout: 10000
//         })
//           .first()
//           .then(elem => {
//             var elemPos = Cypress.dom.getElementCoordinatesByPosition(elem);
//             cy.get("body")
//               .click(
//                 elemPos.fromViewport.leftCenter,
//                 elemPos.fromViewport.topCenter,
//                 { force: true }
//               )
//               .click(
//                 elemPos.fromViewport.leftCenter,
//                 elemPos.fromViewport.topCenter
//               )
//               .trigger(
//                 "contextmenu",
//                 elemPos.fromViewport.leftCenter,
//                 elemPos.fromViewport.topCenter
//               );

//             cy.get(".react-contexify__item__content")
//               .contains(/^Delete Artboard$/i)
//               .then(elem => {
//                 var dupPos = Cypress.dom.getElementCoordinatesByPosition(elem);
//                 cy.get("body")
//                   .trigger(
//                     "mouseover",
//                     dupPos.fromViewport.leftCenter,
//                     dupPos.fromViewport.topCenter
//                   )
//                   .click(
//                     dupPos.fromViewport.leftCenter,
//                     dupPos.fromViewport.topCenter
//                   );
//               });
//             cy.get("body").type("{command}S");
//             cy.get("div", { timeout: 40000 }).and("not.contain", "saving...");
//           });
//         cy.wait(1000);
//         cy.get("div", { timeout: 40000 }).and("not.contain", "saving...");
//       }
//       cy.task("log", "Count:" + count);
//     });

//     it("will get count of artboards", function() {
//       cy.get("div[data-cypress-id=artboard]")
//         .its("length")
//         .then(len => {
//           count = len;
//           cy.task("log", "artboards count = " + len);
//           if (len >= 1) {
//             cy.task("log", "lastArtboard");
//           }

//           if (len >= 1) {
//             screenshotSyncAndDelete();
//           }
//         });
//     });
//   });
// }
