import { SessionEvent } from "event-manager";
import { Session, DesignerKeyboardEvent, Stage } from "session";
import { Utils } from "utils";

const globalData: any = {};

const keyDownFunc = function(event: any) {
  if (!Utils.isEditableInput() && globalData.session) {
    globalData.session.currentStage.canvas.dispatchEvent(
      "keyDown",
      new DesignerKeyboardEvent(
        "keyDown",
        globalData.session.currentStage.canvas,
        event
      )
    );
  }
};
const keyUpFunc = function(event: any) {
  if (!Utils.isEditableInput() && globalData.session) {
    globalData.session.currentStage.canvas.dispatchEvent(
      "keyUp",
      new DesignerKeyboardEvent(
        "keyUp",
        globalData.session.currentStage.canvas,
        event
      )
    );
  }
};
const blurFunc = function(event: any) {
  if (globalData.session) {
    const keyCodes: Array<any> = globalData.session.keyboardService.getCurrentKeyData();
    keyCodes.forEach((keyData: any) => {
      globalData.session.currentStage.canvas.dispatchEvent(
        "keyUp",
        new DesignerKeyboardEvent(
          "keyUp",
          globalData.session.currentStage.canvas,
          keyData
        )
      );
    });
    globalData.session.currentStage.canvas.dispatchEvent(
      "blur",
      new DesignerKeyboardEvent(
        "blur",
        globalData.session.currentStage.canvas,
        event
      )
    );
  }
};
export default function SetCurrentStageGlue(session: Session, e: SessionEvent) {
  globalData.session = session;
  const stage: Stage = e.payload.stage;
  const viewport = e.payload.viewport;
  stage.canvas.setViewport(viewport);

  if (e.payload.oldStageId) {
    document.removeEventListener("keydown", keyDownFunc);
    document.removeEventListener("keyup", keyUpFunc);
    window.removeEventListener("blur", blurFunc);
  }
  document.addEventListener("keydown", keyDownFunc);
  document.addEventListener("keyup", keyUpFunc);
  window.addEventListener("blur", blurFunc);

  // heavy-jugaad scrollview stage scroll not setting properly
  // for symbol stage and artboard stage its working fine
  setTimeout(() => {
    stage.canvas.executeFunction("setScroll", stage.canvas.getScroll());
  });
}
