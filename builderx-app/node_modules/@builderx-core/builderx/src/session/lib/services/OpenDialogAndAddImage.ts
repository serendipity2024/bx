import { action } from "model";
import AddImage from "../Commands/Image/AddImage";
import { Session } from "./../models/Session";
import { FocusArtboard } from "../Commands";

export default function OpenDialogAndAddImage(session: Session) {
  return new Promise((resolve, reject) => {
    try {
      const selector = document.createElement("input");
      selector.setAttribute("type", "file");
      selector.setAttribute("id", "image-file-selector");
      selector.setAttribute("accept", "image/*");
      selector.onchange = (e: any) => {
        if (e.target.files && e.target.files[0]) {
          session
            .checkImageType(e.target.files[0])
            .then(result => {
              //
              session.commandManager.execute(new AddImage(session, [result]));
              action(() => {
                session.commandManager.executeAndSkip(
                  new FocusArtboard(session, session.selectedFile)
                );
              });
            })
            .catch(err => {
              //
              session.notificationManager.notifyError(
                "Invalid file format. Use .png, .jpg, .gif or .sketch",
                "File format"
              );
            });

          resolve(true);
        }
      };
      selector.click();
    } catch (error) {
      reject(error);
    }
  });
}
