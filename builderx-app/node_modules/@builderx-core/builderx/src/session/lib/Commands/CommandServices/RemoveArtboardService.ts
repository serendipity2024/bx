import { Session } from "../../models/Session";
import RemoveFileMutator from "../../Mutators/RemoveFileMutator";
import { GetNextValidArtboard } from "./GetNextValidArtboard";
import DeselectAllLayers from "./DeselectAllLayers";
import SelectFile from "./SelectFile";
import SelectRootLayer from "./SelectRootLayer";
import createService from ".";
import { RemoveLayerMutator } from "../../Mutators";

const RemoveArtboardService = createService(
  "RemoveArtboardService",
  (
    session: Session,
    filePath: string,
    shouldPlaceArtboard: boolean = false
  ) => {
    const file = session.getLayerFromLayerPath(filePath);
    file.isResizerVisible = false;
    const oldDirtyFiles = session.dirtyFiles;
    oldDirtyFiles.forEach((dirtyFile: any, index: number) => {
      if (dirtyFile === file) {
        session.dirtyFiles.splice(index, 1);
      }
    });

    const layerPath = file.layer.getFullPath();

    RemoveLayerMutator(session, layerPath);
    // if (file.isSymbol()) {
    //   stageId = filePath;
    // }
    RemoveFileMutator(session, filePath);

    const currentStage = session.currentStage;

    if (shouldPlaceArtboard) {
      DeselectAllLayers(session);
    }

    let nextValidArtboard = GetNextValidArtboard(session);

    if (nextValidArtboard) {
      SelectFile(session, nextValidArtboard.getFullPath());

      SelectRootLayer(session);
    }
  }
);

export default RemoveArtboardService;
