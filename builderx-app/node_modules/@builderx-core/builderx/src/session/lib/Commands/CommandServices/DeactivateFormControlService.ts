import { Session } from "../../models/Session";
import { SetPropMutator, SetStyleAttributeMutator } from "../../Mutators";
import createService from ".";
import { find } from "lodash";
import { FormControl } from "domain-x";

export const DeactivateFormControlService = createService(
  "DeactivateFormControlService",
  (session: Session, symbolInstanceId: string, overrideKey: string) => {
    const symbolInstance = session.getLayerFromLayerPath(symbolInstanceId);
    const symbolFile = session.domain.getSymbolFileFromSymbolInstance(
      symbolInstance
    );

    if (!symbolFile) {
      return;
    }
    const formControl: any = find(
      symbolFile.formControls,
      (formControl1: FormControl) => {
        return formControl1.title === overrideKey;
      }
    );

    if (!formControl) {
      return;
    }

    const layer = session.getLayerFromLayerPath(formControl.layerPath);

    let value;
    if (layer.type === "text") {
      value =
        layer.children && layer.children.length
          ? (layer.children[0] as any).value
          : "";
    } else if (layer.type === "textInput") {
      value = layer.props.getResolvedProp("placeholder");
    } else if (layer.type === "view") {
      value = layer.props.getResolvedStyleAttribute("backgroundColor");
    } else if (layer.type === "icon") {
      let propName = formControl.title.endsWith("Family") ? "type" : "name";
      value = layer.props.getResolvedProp(propName);
    } else if (layer.type === "touchableOpacity") {
      value = layer.props.getResolvedProp("onPress");
    }

    if (layer.type === "text") {
      layer.children[0] = value;
    } else if (layer.type === "textInput") {
      SetPropMutator(session, layer, "placeholder", value);
    } else if (layer.type === "view") {
      SetStyleAttributeMutator(session, layer, "backgroundColor", value);
    } else if (layer.type === "icon") {
      let propName = formControl.title.endsWith("Family") ? "type" : "name";

      SetPropMutator(session, layer.getFullPath(), propName, value);
      layer.props[propName] = value;
    } else if (layer.type === "touchableOpacity") {
      SetPropMutator(session, layer.getFullPath(), "onPress", value);
      // this.session.commandManager.executeAndSkip(
      //   new SetProp(this.session, layer, "onPress", layerJSON)
      // );
    }
  }
);
