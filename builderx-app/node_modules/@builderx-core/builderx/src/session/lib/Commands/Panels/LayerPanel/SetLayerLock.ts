import { ICommand } from "command-manager";
import { Layer as DomainLayer } from "domain-x";
import { Session } from "../../../models/Session";
import SelectRootLayer from "../../CommandServices/SelectRootLayer";
import RemoveHoveredForAllLayers from "../../CommandServices/RemoveHoveredForAllLayers";
import { SetLayerLockMutator } from "../../../Mutators";
import DeselectAllLayers from "../../CommandServices/DeselectAllLayers";
import SelectLayersService from "../../CommandServices/SelectLayersService";
export default class SetLayerLock implements ICommand {
  displayName = "SetLayerLock";
  session: Session;
  layerId: string;
  lock: boolean;
  selected: boolean;
  constructor(session: Session, layer: DomainLayer, lock: boolean) {
    this.session = session;
    this.lock = lock;
    this.layerId = layer.getFullPath();
  }
  lockLayers() {
    const layer = this.session.getLayerFromLayerPath(this.layerId);
    if (layer.type === "root") {
      return;
    }
    this.selected = layer.selected;

    if (this.selected) {
      DeselectAllLayers(this.session);
      SelectRootLayer(this.session);
    } else {
      RemoveHoveredForAllLayers(this.session);
    }
    SetLayerLockMutator(this.session, this.layerId, this.lock);
  }
  execute() {
    this.lockLayers();
    this.session.drivers.analyticsService.addActivity(
      {
        name: `set.layer.lock`,
        path: "",
        category: "app/command"
      },
      true
    );
  }
  undo() {
    const layer = this.session.getLayerFromLayerPath(this.layerId);
    if (layer.type === "root") {
      return;
    }
    SetLayerLockMutator(this.session, this.layerId, !this.lock);
    if (this.selected) {
      SelectLayersService(this.session, [this.layerId]);
    }
    this.session.drivers.analyticsService.addActivity(
      {
        name: `undo.layer.lock`,
        path: "",
        category: "app/command"
      },
      true
    );
  }
  redo() {
    this.lockLayers();
    this.session.drivers.analyticsService.addActivity(
      {
        name: `redo.layer.lock`,
        path: "",
        category: "app/command"
      },
      true
    );
  }
}
