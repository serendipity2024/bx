import { Session } from "../../models/Session";
import { DomainFile } from "domain-x";
import SelectFileService from "./SelectFile";
import createService from ".";
import {
  AddFileMutator,
  SetDrawTypeMutator,
  SetGridVisibilityMutator
} from "../../Mutators";
import { cloneDeep, get } from "lodash";
import { AddLayerService } from "./AddLayerService";
import FocusArtboardMutator from "../../Mutators/FocusArtboardMutator";
import { AddFileScopeVariables } from "./AddFileScopeVariables";
import { SetAllPropsService } from "./SetAllPropsService";
import PlaceArtboardsToCenter from "./PlaceArtboardsToCenter";
import SetDeviceNameService from "./SetDeviceName";
import SetDeviceOrientationService from "./SetDeviceOrientation";
import SetStatusBarMutator from "../../Mutators/SetStatusBarMutator";

const setProps = (session: Session, file: DomainFile, fileJSON: any) => {
  SetAllPropsService(session, file.getFullPath(), fileJSON.props);
  if (fileJSON.layer) {
    const layerJSON = cloneDeep(fileJSON.layer);
    AddLayerService(session, fileJSON.path, layerJSON, "layer");
  }
};

const AddArtboardService = createService(
  "AddArtboardService",
  (session: Session, fileJSON: any) => {
    const file = AddFileMutator(
      session,
      fileJSON.path,
      fileJSON.version,
      fileJSON.dbFileId
    );
    setProps(session, file, fileJSON);
    SetDrawTypeMutator(session, "default");
    let gridVisibility = session.drivers.configuration.get("editor.show.grid");
    SetGridVisibilityMutator(session, gridVisibility);
    if (fileJSON.layer) {
      SelectFileService(session, fileJSON.path);
    }
    AddFileScopeVariables(session, fileJSON);
    SetDeviceNameService(
      session,
      fileJSON.path,
      get(fileJSON, "scopeVariables.deviceName", session.project.deviceName)
    );
    SetDeviceOrientationService(
      session,
      fileJSON.path,
      get(
        fileJSON,
        "scopeVariables.deviceOrientation",
        session.project.deviceOrientation
      )
    );
    FocusArtboardMutator(session, fileJSON.path);

    SetStatusBarMutator(session, fileJSON.path, fileJSON.statusBar);
    PlaceArtboardsToCenter(session);

    return file;
  }
);

export default AddArtboardService;
