import { Session } from "../models/Session";
import { SessionEvent } from "event-manager";

export default function SetZoomMutator(session: Session, zoom: number) {
  // TODO: Remove that hack @Suraj (zoom is being initialised as 0)
  zoom = zoom === 0 ? 1 : zoom;
  const canvas = session.currentStage.canvas;
  let drawType = session.currentStage.tools.draw.getType();
  if (
    canvas.executeFunction("GradientEditor.isOpen") ||
    drawType === "path" ||
    drawType === "text"
  ) {
    return;
  }
  if (canvas) {
    const viewport = canvas.getViewport();
    const contentWidth = canvas.layout.get("width");
    const contentHeight = canvas.layout.get("height");

    if (
      contentWidth * zoom > viewport.width &&
      contentHeight * zoom > viewport.height
    ) {
      //
    } else {
      //
      zoom =
        Math.max(
          viewport.height / contentHeight,
          viewport.width / contentWidth
        ) + 0.001;
    }

    // const newZoomContainerWidth = zoom * canvas.layout.get("width");
    // if (newZoomContainerWidth > viewportWidth) {
    // session.currentStage.tools.zoom = zoom;
    session.emitPatch({
      op: "replace",
      path: `/currentStage/tools/zoom`,
      value: zoom
    });
    // }

    // session.currentStage.tools.emit("zoom");
    // const event = new SessionEvent("setZoom", {
    //   zoom
    // });
    // session.eventManager.dispatchEvent("setZoom", event);
  }
}
