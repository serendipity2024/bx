import { Session } from "../models/Session";
import { SessionEvent } from "event-manager";
import SelectLayersMutator from "./SelectLayersMutator";
import SelectFileMutator from "./SelectFileMutator";
import DeselectAllLayersMutator from "./DeselectAllLayersMutator";
import RemoveHoveredForAllLayersMutator from "./RemoveHoveredForAllLayersMutator";

export default function SetCurrentStageMutator(
  session: Session,
  stageId: string
) {
  const stage = session.stages.get(stageId);
  RemoveHoveredForAllLayersMutator(session);
  DeselectAllLayersMutator(session);
  let currentViewport = {
    width: 800,
    height: 800
  };
  let oldStageId;
  if (session.currentStage) {
    currentViewport = session.currentStage.canvas.getViewport();
  }
  if (!stage) {
    return;
  }

  if (session.currentStage) {
    oldStageId = session.currentStage.id;
    session.currentStage.canvasContainerDom.style.visibility = "hidden";

    // if (session.currentStage.id.includes("layer:")) {
    //   RemoveStageMutator(session, session.currentStage.id);
    // }
  }
  if (stage.canvasContainerDom && session.currentStage) {
    stage.canvasContainerDom.style.visibility = "visible";
  }

  session.emitPatch({
    op: "replace",
    path: "/currentStage",
    value: stage
  });
  // session.currentStage = stage;

  if (session.currentStage.id === "artboard") {
    if (session.currentStage.stageArtboards[0]) {
      SelectFileMutator(session, session.currentStage.stageArtboards[0].path);
      let rootLayer = session.selectedFile
        ? session.selectedFile.layer
        : undefined;
      if (rootLayer) {
        // session.setCurrentRootLayer(rootLayer);
        session.emitPatch({
          op: "replace",
          path: "/currentRootLayer",
          value: rootLayer
        });
      }
      DeselectAllLayersMutator(session);
      SelectLayersMutator(session, [
        session.currentStage.stageArtboards[0].rootLayerId
      ]);
    }
  } else if (session.currentStage.id.includes("layer:")) {
    let rootLayer = session.selectedFile
      ? session.selectedFile.layer
      : undefined;
    if (stage && stage.id.includes("layer:")) {
      rootLayer = session.getLayerFromLayerPath(
        stage.stageArtboards[0].rootLayerId
      );
    }
    SelectFileMutator(session, session.currentStage.stageArtboards[0].path);
    if (rootLayer) {
      // session.setCurrentRootLayer(rootLayer);
      session.emitPatch({
        op: "replace",
        path: "/currentRootLayer",
        value: rootLayer
      });
    }
  } else {
    SelectFileMutator(session, session.currentStage.id);
    DeselectAllLayersMutator(session);
    SelectLayersMutator(session, [
      session.currentStage.stageArtboards[0].rootLayerId
    ]);
  }

  // session.emit("currentStage");

  // session.eventManager.dispatchEvent(
  //   "setCurrentStage",
  //   new SessionEvent("setCurrentStage", {
  //     stage,
  //     viewport: currentViewport,
  //     oldStageId
  //   })
  // );
}
