import * as React from "react";
import {
  Window,
  WindowFooter,
  WindowBody,
  Text,
  Pane,
  FormCol,
  FormRow,
  FormGroup,
  Button,
  ButtonGroup,
  ModalContainer,
  ModalBackdrop,
  ModalContent,
  Scrollbars,
  Icon
} from "components-x";
import { Session } from "../../../models/Session";
import SetModalRoute from "../../../Commands/Router/SetModalRoute";
import { action } from "model";
import urljoin from "url-join";
const fontErrorText = `System fonts could not be loaded.
You can download BuilderX Desktop Manager app. If you have already installed it, please run it.`;
const oldVersionErrorText = `Your version of BuilderX Desktop Manager is outdated.
 Please download the new version by clicking below. If prompted during installation,
  please choose to replace the previous copy of the app.`;
export default class WarningModal extends React.PureComponent<
  { session: Session },
  any
> {
  constructor(props: any) {
    super(props);
  }
  componentDidMount() {
    document.addEventListener("keyup", this._handleKeyDown);
  }
  componentWillUnmount() {
    document.removeEventListener("keyup", this._handleKeyDown);
  }
  _handleKeyDown = (event: any) => {
    const ESCAPE_KEY = 27;
    const ENTER_KEY = 13;
    switch (event.keyCode) {
      case ESCAPE_KEY:
        this.exitModal();
        break;
      case ENTER_KEY:
        this.exitModal();
        break;
      default:
        break;
    }
  };
  exitModal = () => {
    action(() => {
      this.props.session.commandManager.executeAndSkip(
        new SetModalRoute(this.props.session, "")
      );
    });
  };
  render() {
    let missingFonts = this.props.session.project.missingFonts;
    return (
      <ModalContainer>
        <ModalBackdrop onClick={this.exitModal} />
        <ModalContent uiSize="m">
          <Window
            uiSize="m"
            onKeyPress={(e: any) => {
              if (e.keyCode === 27 || e.keyCode === 13) {
                this.exitModal();
              }
            }}
            id="warning-modal"
          >
            <WindowBody>
              <Pane uiBackground={800} className="py-4">
                {missingFonts.length > 0 ? (
                  <FormGroup noPaddingBottom noPaddingTop className="px-4">
                    <FormRow>
                      <FormCol
                        className="pl-0 pr-2"
                        style={{
                          paddingTop: 5,
                          alignSelf: "flex-start",
                          flex: 1
                        }}
                      >
                        <Icon name={"warning"} size={18} />
                      </FormCol>
                      <Text uiSize="m" style={{ lineHeight: 1.6, flex: 25 }}>
                        Some fonts in the project are missing.
                      </Text>
                    </FormRow>
                    <FormRow className="pl-5">
                      <Text
                        uiSize={"m"}
                        uiColor={400}
                        style={{ lineHeight: 1.6 }}
                      >
                        The following fonts are used but could not be found.
                      </Text>
                    </FormRow>
                    <FormRow className="pl-5">
                      <Scrollbars autoHide autoHeight>
                        <Pane
                          padder="xs"
                          uiBackground={600}
                          style={{
                            paddingTop: 10,
                            paddingBottom: 10
                          }}
                        >
                          {missingFonts.map((missingFont: any, i: any) => {
                            return (
                              <FormRow
                                key={i}
                                noTopPadding={i === 0}
                                noPadding={i === missingFonts.length - 1}
                              >
                                <FormCol
                                  first={true}
                                  style={{ marginLeft: 13, marginRight: 13 }}
                                >
                                  <Text uiSize={"s"}>{missingFont}</Text>
                                </FormCol>
                              </FormRow>
                            );
                          })}
                        </Pane>
                      </Scrollbars>
                    </FormRow>
                  </FormGroup>
                ) : null}
                {!this.props.session.fontUrl &&
                  (this.props.session.platform === "Mac" ||
                    this.props.session.platform === "Windows") && (
                    <FormGroup noPaddingBottom className="px-4">
                      <FormRow>
                        <FormCol
                          className="pl-0 pr-2"
                          style={{
                            paddingTop: 5,
                            alignSelf: "flex-start",
                            flex: 1
                          }}
                        >
                          <Icon name={"warning"} size={18} />
                        </FormCol>
                        <Text uiSize="m" style={{ lineHeight: 1.6, flex: 25 }}>
                          {this.props.session.oldFontsTrayVersion
                            ? oldVersionErrorText
                            : fontErrorText}
                        </Text>
                      </FormRow>
                    </FormGroup>
                  )}
              </Pane>
            </WindowBody>
            <WindowFooter>
              <Pane className="p-4" uiBackground={800}>
                <ButtonGroup contentRight>
                  {!this.props.session.fontUrl &&
                    (this.props.session.platform === "Mac" ||
                      this.props.session.platform === "Windows") && (
                      <Button
                        actionBtn
                        uiBackground={500}
                        paddingLeft={16}
                        paddingRight={16}
                        border
                        caption="Download Desktop Manager"
                        minWidth
                        uiSize="m"
                        onClick={() => {
                          window.open(
                            urljoin(
                              this.props.session.envConstants.WEBSITE_URL,
                              "desktop-app-server",
                              "download"
                            )
                          );
                        }}
                        marginRight={true}
                        active
                      />
                    )}
                  <Button
                    actionBtn
                    uiBackground={500}
                    border
                    caption="Ok"
                    minWidth
                    uiSize="m"
                    onClick={this.exitModal}
                    active
                  />
                </ButtonGroup>
              </Pane>
            </WindowFooter>
          </Window>
        </ModalContent>
      </ModalContainer>
    );
  }
}
